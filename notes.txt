import pandas as pd
from pmdarima import auto_arima

# Load your dataset
df = pd.read_csv("your_data.csv")

# Convert 'Close Month' and 'Close Year' to datetime
df['Close Month'] = pd.to_datetime(df['Close Month'].astype(int).astype(str) + '-' + df['Close Year'].astype(int).astype(str), format='%m-%Y')

# Set 'Close Month' as the index
df.set_index('Close Month', inplace=True)

# Recognize current year and month
current_year = df.index[-1].year
current_month = df.index[-1].month

# Filter data for the specified countries and the current year
countries = ['AUS', 'USIS', 'CAN']
df_current_year = df[(df.index.year == current_year) & (df['BU/COE'].isin(countries))]

# Group by 'BU/COE' and resample to monthly frequency, summing 'Total Incremental Revenue'
df_grouped = df_current_year.groupby('BU/COE')['Total Incremental Revenue'].resample('M').sum().reset_index()

# Initialize empty DataFrame for predictions
predictions_df = pd.DataFrame(columns=['Close Month', 'BU/COE', 'Revenue Prediction'])

# Loop through each BU/COE
for group, df_group in df_grouped.groupby('BU/COE'):
    try:
        # Fit auto ARIMA model
        model = auto_arima(df_group['Total Incremental Revenue'], seasonal=True, m=12)
        
        # Forecast remaining months of the current year
        forecast_steps = 12 - current_month + 1
        forecast = model.predict(n_periods=forecast_steps)
        
        # Append predictions with BU/COE and forecast
        for i, pred in enumerate(forecast):
            month = current_month + i
            predictions_df = predictions_df.append({'Close Month': pd.to_datetime(f"{current_year}-{month}-01", format='%Y-%m-%d'), 'BU/COE': group, 'Revenue Prediction': pred}, ignore_index=True)
    except:
        print(f"Unable to fit auto ARIMA model for {group}")

# Create a new column 'Total Incremental Revenue Prediction' with cumulative sum by BU/COE
predictions_df['Total Incremental Revenue Prediction'] = predictions_df.groupby('BU/COE')['Revenue Prediction'].cumsum()

# Output predictions_df
predictions_df
